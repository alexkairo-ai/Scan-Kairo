<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Готовность производства</title>
<style>
:root{
 --glass:rgba(18,20,26,.72); /* полупрозрачный тёмно‑серый */
 --gold:#caa24f;
 --gold-hi:#f4e3a1;
 --text:#f7f8fb;
 --muted:#d7caa0;
}
*{box-sizing:border-box}
body{
 margin:0;
 color:var(--text);
 font-family:"SF Pro Display","Inter",system-ui,Arial,sans-serif;
 background:
 linear-gradient(rgba(0,0,0,.55), rgba(0,0,0,.55)),
 url("https://i.pinimg.com/1200x/17/d6/26/17d626d329d068ad30f4e3eebbda1e23.jpg") center/cover fixed no-repeat;
}
.wrap{max-width:780px;margin:0 auto;padding:clamp(14px,3vw,22px)}

.card{
 position:relative;
 background:
 radial-gradient(140%140% at10%0%, rgba(255,255,255,.06), transparent60%),
 linear-gradient(135deg, rgba(255,255,255,.04), rgba(0,0,0,.35)),
 var(--glass);
 border:2px solid var(--gold);
 border-radius:24px;
 padding:clamp(16px,3vw,24px);
 margin-bottom:clamp(12px,3vw,18px);
 box-shadow:
018px42px rgba(0,0,0,.5),
 inset01px0 rgba(255,255,255,.18),
 inset0 -3px8px rgba(0,0,0,.6);
}
.card:before{
 content:"";
 position:absolute;
 inset:2px;
 border-radius:22px;
 border:1px solid rgba(255,255,255,.06);
 pointer-events:none;
}
.card:after{
 content:"";
 position:absolute;
 inset:0;
 border-radius:24px;
 box-shadow:
0024px rgba(202,162,79,.18),
 inset0018px rgba(202,162,79,.12);
 pointer-events:none;
}

h2{
 font-size:clamp(22px,5vw,32px);
 margin:006px;
 text-shadow:02px6px rgba(0,0,0,.6);
}
h3{
 font-size:clamp(18px,4vw,24px);
 margin:6px010px;
 color:var(--muted);
 text-shadow:02px6px rgba(0,0,0,.5);
}

video{
 width:100%;
 border-radius:16px;
 border:2px solid rgba(255,255,255,.12);
 background:#000;
 pointer-events:none;
 box-shadow:010px24px rgba(0,0,0,.5), inset0010px rgba(255,255,255,.06);
}

input{
 font-size:clamp(16px,4.2vw,22px);
 padding:clamp(10px,3vw,14px) clamp(12px,3vw,16px);
 width:100%;
 border-radius:16px;
 border:2px solid var(--gold);
 background:rgba(8,10,14,.75);
 color:#fff;
 margin-top:8px;
 outline:none;
 box-shadow:
 inset01px0 rgba(255,255,255,.12),
08px18px rgba(0,0,0,.35);
}
input:focus{
 border-color:var(--gold-hi);
 box-shadow:0002px rgba(244,227,161,.18),08px18px rgba(0,0,0,.4);
}

button{
 font-size:clamp(18px,4.6vw,26px);
 font-weight:900;
 letter-spacing:.4px;
 padding:clamp(12px,3.2vw,16px);
 width:100%;
 border-radius:18px;
 margin-top:10px;

 /* фон кнопки */
 background:
 linear-gradient(rgba(0,0,0,.28), rgba(0,0,0,.28)),
 url("https://i.pinimg.com/1200x/ab/60/f9/ab60f9ee3911eab2ca23f391a5fd9622.jpg") center/cover no-repeat;
 border:2px solid var(--gold);
 box-shadow:
014px28px rgba(0,0,0,.45),
 inset01px0 rgba(255,255,255,.28),
 inset0 -4px10px rgba(0,0,0,.55);

 /* текст «выжженный/выбитый» */
 color: rgba(30,20,12,0.85);
 text-shadow:
0 -1px1px rgba(0,0,0,0.7),
01px0 rgba(255,255,255,0.25),
02px6px rgba(0,0,0,0.65);
 -webkit-text-stroke:0.6px rgba(0,0,0,0.5);
 filter: drop-shadow(02px3px rgba(0,0,0,0.4));
}
button:active{
 transform:translateY(1px);
 box-shadow:010px20px rgba(0,0,0,.45), inset01px0 rgba(255,255,255,.22);
}

#startCam{display:block}

.small{
 font-size:clamp(12px,3.2vw,16px);
 color:var(--muted);
 text-shadow:02px5px rgba(0,0,0,.55);
}
#status{
 margin-top:10px;
 font-weight:800;
 font-size:clamp(14px,3.6vw,18px);
 min-height:20px;
 padding:8px10px;
 background:rgba(0,0,0,.35);
 border-radius:12px;
 border:1px solid rgba(255,255,255,.08);
 box-shadow:inset01px0 rgba(255,255,255,.08),08px18px rgba(0,0,0,.35);
 text-shadow:02px6px rgba(0,0,0,.6);
}

.badge{
 display:inline-block;
 font-size:clamp(12px,3vw,16px);
 padding:6px12px;
 border-radius:999px;
 background:linear-gradient(135deg, rgba(255,255,255,.14), rgba(0,0,0,.2));
 border:1px solid var(--gold);
 color:var(--gold-hi);
 text-shadow:02px6px rgba(0,0,0,.6);
 box-shadow:06px16px rgba(0,0,0,.35), inset01px0 rgba(255,255,255,.2);
}
.grid{display:grid;gap:8px}
</style>
</head>
<body>
<div class="wrap">

 <div class="card">
 <div class="badge">Готовность производства</div>
 <h2>Сканируйте QR заказа</h2>
 <video id="video" autoplay playsinline muted></video>
 <canvas id="canvas" style="display:none;"></canvas>
 <div id="msg" class="small"></div>
 <button id="startCam">СКАНИРОВАТЬ</button>
 </div>

 <div class="card">
 <div class="grid">
 <input id="order" placeholder="QR / номер заказа" autofocus />
 <input id="worker" placeholder="Имя сотрудника" />
 </div>
 </div>

 <div class="card">
 <h3>Выберите этап:</h3>
 <button onclick="sendStage('pila')">Пила</button>
 <button onclick="sendStage('hdf')">ХДФ</button>
 <button onclick="sendStage('kromka')">Кромка</button>
 <button onclick="sendStage('prisadka')">Присадка</button>
 <button onclick="sendStage('upakovka')">Упаковка</button>
 <div id="status">Готово к работе</div>
 </div>
</div>

<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbxkd82t9NGFfboV2FDy7klyIyLoBK-3Vlzo7z9vNEUVabG5EsEP3SqJuiOyRfs5zeFeMw/exec';

const orderInput = document.getElementById("order");
const workerInput = document.getElementById("worker");
const statusEl = document.getElementById("status");
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const startBtn = document.getElementById("startCam");
const msg = document.getElementById("msg");

let stream = null;
let locked = false;
let starting = false;
let stopTimer = null;

function isStreamActive(){
 return stream && stream.getTracks().some(t => t.readyState === "live");
}
function showScanButton(show){ startBtn.style.display = show ? "block" : "none"; }
function stopCamera(){
 if (stream) stream.getTracks().forEach(t => t.stop());
 stream = null;
 if (stopTimer) { clearTimeout(stopTimer); stopTimer = null; }
 showScanButton(true);
}
function freezeCamera(){
 if (stream) stream.getTracks().forEach(t => t.stop());
 locked = true;
 if (stopTimer) { clearTimeout(stopTimer); stopTimer = null; }
 showScanButton(true);
}

async function startCamera(){
 if (starting) return;
 starting = true;
 try{
 stream = await navigator.mediaDevices.getUserMedia({
 video: { facingMode: { ideal: "environment" }, width: { ideal:1280 }, height:{ ideal:720 } },
 audio: false });
 video.srcObject = stream;
 await video.play();
 locked = false;
 showScanButton(false);

 if (stopTimer) clearTimeout(stopTimer);
 stopTimer = setTimeout(() => {
 if (!locked) { msg.innerHTML = "Сканирование остановлено. Нажмите «СКАНИРОВАТЬ»."; stopCamera(); }
 },20000);

 scan();
 }catch(e){
 msg.innerHTML = "Камера не запустилась. Откройте сайт в Chrome/Safari и дайте доступ.";
 showScanButton(true);
 console.log(e);
 }finally{
 starting = false;
 }
}

startBtn.addEventListener("click", startCamera);

function callApi(params, cb){
 const cbName = 'cb_' + Math.random().toString(36).slice(2);
 let done = false;

 const timeout = setTimeout(() => {
 if (!done) {
 done = true;
 statusEl.innerHTML = "⏳ Обрабатывается (долго)";
 window[cbName] && delete window[cbName];
 }
 },25000);

 window[cbName] = function(res){
 if (done) return;
 done = true;
 clearTimeout(timeout);
 cb(res);
 delete window[cbName];
 script.remove();
 };

 const query = new URLSearchParams(params);
 query.set('api','1');
 query.set('callback', cbName);
 query.set('_ts', Date.now().toString());

 const script = document.createElement('script');
 script.src = API_URL + '?' + query.toString();
 script.onerror = () => {
 if (done) return;
 done = true;
 clearTimeout(timeout);
 statusEl.innerHTML = "⚠️ Ошибка связи с сервером";
 script.remove();
 };
 document.body.appendChild(script);
}

function sendStage(stage){
 let raw = orderInput.value.trim();
 let name = workerInput.value.trim();
 if(!raw){ statusEl.innerHTML="Введите/сканируйте номер"; return; }
 if(!name){ statusEl.innerHTML="Введите имя"; return; }
 statusEl.innerHTML="Отправка...";

 callApi({
 action:'mark',
 stage:stage,
 order:raw,
 name:name,
 db:''
 }, function(res){
 statusEl.innerHTML = res.ok ? "✅ Готово" : "⚠️ " + res.msg;
 });
}

function scan(){
 if(locked) return;
 if(!isStreamActive()){ startCamera(); return; }

 if(video.readyState===video.HAVE_ENOUGH_DATA){
 canvas.width=video.videoWidth;
 canvas.height=video.videoHeight;
 ctx.drawImage(video,0,0,canvas.width,canvas.height);
 const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
 const code=jsQR(imageData.data,imageData.width,imageData.height, { inversionAttempts:"attemptBoth" });
 if(code){
 orderInput.value=code.data;
 msg.innerHTML="QR найден: " + code.data;
 if (navigator.vibrate) navigator.vibrate(80);
 freezeCamera();
 return;
 }
 }
 requestAnimationFrame(scan);
}
</script>
</body>
</html>
